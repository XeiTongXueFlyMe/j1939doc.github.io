<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.14"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>J1939Socket: 简单的使用DEMO</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
  $(document).ready(initResizable);
/* @license-end */</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">J1939Socket
   &#160;<span id="projectnumber">Version 2.1.0</span>
   </div>
   <div id="projectbrief">基于SAE J1939协议，开源可移植的J1939驱动，本说明书看齐最新源代码，如遇接口描述不同请更新源代码(github)。</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- 制作者 Doxygen 1.8.14 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "search",false,'搜索');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('',true,false,'search.php','搜索');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('labelid3.html','');});
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">简单的使用DEMO </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md24"></a>
一个最简单的使用事例</h1>
<blockquote class="doxtable">
<p>1.假设已经将J1939协议栈移植完毕，CAN驱动也正常工作 2.采用轮训模式 3.简单的发送和接受J1939数据 </p>
</blockquote>
<blockquote class="doxtable">
<p>直接上代码： </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keywordtype">void</span> sendMsg( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html">J1939_MESSAGE</a> _msg;</div><div class="line">    <span class="comment">/*****发送数据(参考J1939的ID组成填充下面)***/</span></div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a6b25f85b55c0d06ad98b8d472ba85937">DataPage</a> = 0;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#aed045d88b5b0a4a8dc72486d612a772c">Priority</a> = J1939_CONTROL_PRIORITY;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.DestinationAddress = 0x0f;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a311918f94c3980a2f7d011b93cc3c223">DataLength</a> = 8;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#aa880f27ed7c7789066020f8fab6f94cd">PDUFormat</a> = 0xfe;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[0] = 1;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[1] = 2;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[2] = 3;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[3] = 4;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[4] = 5;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[5] = 6;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[6] = 7;</div><div class="line">    _msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.<a class="code" href="struct_j1939___m_e_s_s_a_g_e___u_n_i_o_n_1_1j1939___p_i_d.html#a1da55828924eebb623e9f8eefb0715f7">Data</a>[7] = 8;</div><div class="line">    <span class="keywordflow">while</span> (<a class="code" href="_j1939_8h_a226371f1c2c24ccc6c2ce13f0fbb2412.html#a226371f1c2c24ccc6c2ce13f0fbb2412">J1939_Send_Message</a>( &amp;_msg, <a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>) != RC_SUCCESS);</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> readMsg( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html">J1939_MESSAGE</a> _msg[2];</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="_j1939_8h_abf1da75af4a339cf813e76205b281480.html#abf1da75af4a339cf813e76205b281480">J1939_Read_Message</a>( _msg, <a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>) == RC_SUCCESS) </div><div class="line">    {</div><div class="line">        <span class="comment">/***********处理接受PUD1格式数据*************/</span></div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x000100)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="_j1939_8h_abf1da75af4a339cf813e76205b281480.html#abf1da75af4a339cf813e76205b281480">J1939_Read_Message</a>( (_msg+1), <a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>) == RC_SUCCESS) </div><div class="line">    {</div><div class="line">        <span class="comment">/***********处理接受PDU2格式数据*************/</span></div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x00F101)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <span class="comment">//初始化can驱动，定时器初始化</span></div><div class="line">    init_can();</div><div class="line">    timerInit(10);</div><div class="line">    <span class="comment">//初始化J1939协议栈</span></div><div class="line">    <a class="code" href="_j1939_8h_ab49a630de94d8e03e275e3691626d89e.html#ab49a630de94d8e03e275e3691626d89e">J1939_Initialization</a>();</div><div class="line"></div><div class="line">    <span class="comment">//在这里启动定时器</span></div><div class="line">    timerStart();</div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <span class="comment">/*发送一帧数据*/</span></div><div class="line">        sendMsg（）;</div><div class="line">        <span class="comment">/*接受一帧数据*/</span></div><div class="line">        readMsg( );</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">//开启一个定时器 10MS </span></div><div class="line"><span class="keywordtype">void</span> timer_j1939()</div><div class="line">{</div><div class="line">      <a class="code" href="_j1939_8h_adfc3c184a14f94b83a28073a15264d5c.html#adfc3c184a14f94b83a28073a15264d5c">J1939_Poll</a>();</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> delay_10ms(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i,j,k;</div><div class="line">    <span class="keywordflow">for</span>(i=5;i&gt;0;i--)</div><div class="line">        <span class="keywordflow">for</span>(j=4;j&gt;0;j--)</div><div class="line">            <span class="keywordflow">for</span>(k=248;k&gt;0;k--);</div><div class="line">}</div></div><!-- fragment --><h1><a class="anchor" id="autotoc_md25"></a>
使用多帧TP发送数据</h1>
<blockquote class="doxtable">
<p>1.假设已经将J1939协议栈移植完毕，CAN驱动也正常工作 2.采用轮训模式 3.简单的发送多帧J1939数据 </p>
</blockquote>
<blockquote class="doxtable">
<p>直接上代码： </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <a class="code" href="_j1939_8h.html#a9e9f4a9bd6c4a189e06fa67d441d65f7">j1939_int8_t</a> _data[100] = {1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7};</div><div class="line">    <span class="comment">//初始化can驱动，定时器初始化</span></div><div class="line">    init_can();</div><div class="line">    timerInit(10);</div><div class="line">    <span class="comment">//初始化J1939协议栈</span></div><div class="line">    <a class="code" href="_j1939_8h_ab49a630de94d8e03e275e3691626d89e.html#ab49a630de94d8e03e275e3691626d89e">J1939_Initialization</a>();</div><div class="line"></div><div class="line">    <span class="comment">//在这里启动定时器</span></div><div class="line">    timerStart();</div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <a class="code" href="_j1939_8h_a485a992689e86ad9b86c49378c12c673.html#a485a992689e86ad9b86c49378c12c673">J1939_TP_TX_Message</a>(65259,0XF1,(<a class="code" href="_j1939_8h.html#a9e9f4a9bd6c4a189e06fa67d441d65f7">j1939_int8_t</a>*)_data,<span class="keyword">sizeof</span>(_data),<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>);</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">//开启一个定时器 10MS </span></div><div class="line"><span class="keywordtype">void</span> timer_j1939()</div><div class="line">{</div><div class="line">      <a class="code" href="_j1939_8h_adfc3c184a14f94b83a28073a15264d5c.html#adfc3c184a14f94b83a28073a15264d5c">J1939_Poll</a>();</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> delay_10ms(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i,j,k;</div><div class="line">    <span class="keywordflow">for</span>(i=5;i&gt;0;i--)</div><div class="line">        <span class="keywordflow">for</span>(j=4;j&gt;0;j--)</div><div class="line">            <span class="keywordflow">for</span>(k=248;k&gt;0;k--);</div><div class="line">}</div></div><!-- fragment --> <h1><a class="anchor" id="autotoc_md26"></a>
使用多帧TP接受数据</h1>
<blockquote class="doxtable">
<p>1.假设已经将J1939协议栈移植完毕，CAN驱动也正常工作 2.采用轮训模式 3.简单的接受多帧J1939数据 </p>
</blockquote>
<blockquote class="doxtable">
<p>直接上代码： </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <span class="comment">/*定义一些临时变量*/</span></div><div class="line">    <a class="code" href="_j1939_8h.html#abed4986035b5138ce5c8306d2653fe01">j1939_uint8_t</a> _data[255];</div><div class="line">    <a class="code" href="struct_t_p___r_x___m_e_s_s_a_g_e.html">TP_RX_MESSAGE</a> _tp_msg;</div><div class="line"></div><div class="line">    <span class="comment">/*初始化TP接受结构体*/</span></div><div class="line">    _tp_msg.<a class="code" href="struct_t_p___r_x___m_e_s_s_a_g_e.html#abe235e92fcf5e3ffba5a2f990508609d">data</a> = _data;</div><div class="line">    _tp_msg.<a class="code" href="struct_t_p___r_x___m_e_s_s_a_g_e.html#aaa2893f791e31950d596ccda54abf6ec">data_num</a> = 255;</div><div class="line"></div><div class="line">    <span class="comment">//初始化can驱动，定时器初始化</span></div><div class="line">    init_can();</div><div class="line">    timerInit(10);</div><div class="line">    <span class="comment">//初始化J1939协议栈</span></div><div class="line">    <a class="code" href="_j1939_8h_ab49a630de94d8e03e275e3691626d89e.html#ab49a630de94d8e03e275e3691626d89e">J1939_Initialization</a>();</div><div class="line"></div><div class="line">    <span class="comment">//在这里启动定时器</span></div><div class="line">    timerStart();</div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(RC_SUCCESS == <a class="code" href="_j1939_8h_ad6f901a3489250837544956c6460ae15.html#ad6f901a3489250837544956c6460ae15">J1939_TP_RX_Message</a>(&amp;_tp_msg,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>))</div><div class="line">        {</div><div class="line">            <span class="keywordtype">int</span> _i =0;</div><div class="line">            <span class="keywordflow">switch</span> (_tp_msg.<a class="code" href="struct_t_p___r_x___m_e_s_s_a_g_e.html#aeda15e48f0a0f49dd417552c12804dd9">PGN</a>) {</div><div class="line">            <span class="keywordflow">case</span> 4096:  </div><div class="line">                <span class="comment">/*your code*/</span></div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            <span class="keywordflow">default</span>:</div><div class="line">                <span class="keywordflow">break</span>;</div><div class="line">            }</div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">//开启一个定时器 10MS </span></div><div class="line"><span class="keywordtype">void</span> timer_j1939()</div><div class="line">{</div><div class="line">      <a class="code" href="_j1939_8h_adfc3c184a14f94b83a28073a15264d5c.html#adfc3c184a14f94b83a28073a15264d5c">J1939_Poll</a>();</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> delay_10ms(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i,j,k;</div><div class="line">    <span class="keywordflow">for</span>(i=5;i&gt;0;i--)</div><div class="line">        <span class="keywordflow">for</span>(j=4;j&gt;0;j--)</div><div class="line">            <span class="keywordflow">for</span>(k=248;k&gt;0;k--);</div><div class="line">}</div></div><!-- fragment --> <h1><a class="anchor" id="autotoc_md27"></a>
向总线请求一个PGN</h1>
<blockquote class="doxtable">
<p>1.假设已经将J1939协议栈移植完毕，CAN驱动也正常工作 2.采用轮训模式 </p>
</blockquote>
<blockquote class="doxtable">
<p>直接上代码： </p>
</blockquote>
<div class="fragment"><div class="line"><span class="comment">/*向特定地址请求PGN，PGN可以是多帧和单帧的*/</span></div><div class="line"><span class="comment">/*点对点请求*/</span></div><div class="line"><span class="keywordtype">void</span> my_Request_PGN_1( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/*请求一个PDU1格式的PGN*/</span></div><div class="line">    <a class="code" href="_j1939_8h_ade5a2ccfd9902b6d68f7970ab7dab849.html#ade5a2ccfd9902b6d68f7970ab7dab849">J1939_Request_PGN</a>(0x000100,56,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>);</div><div class="line">    <span class="comment">/*请求一个PDU2格式的PGN*/</span></div><div class="line">    <a class="code" href="_j1939_8h_ade5a2ccfd9902b6d68f7970ab7dab849.html#ade5a2ccfd9902b6d68f7970ab7dab849">J1939_Request_PGN</a>(0x00F101,56,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>);</div><div class="line">}</div><div class="line"><span class="comment">/*广播请求PGN，PGN可以是多帧和单帧的*/</span></div><div class="line"><span class="comment">/*点对多请求，可能收到来自不同ECU数据，如果多个ECU对同一个PGN支持*/</span></div><div class="line"><span class="keywordtype">void</span> my_Request_PGN_2( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <span class="comment">/*请求一个PDU1格式的PGN*/</span></div><div class="line">    <a class="code" href="_j1939_8h_ade5a2ccfd9902b6d68f7970ab7dab849.html#ade5a2ccfd9902b6d68f7970ab7dab849">J1939_Request_PGN</a>(0x000101,J1939_GLOBAL_ADDRESS,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>);</div><div class="line">    <span class="comment">/*请求一个PDU2格式的PGN*/</span></div><div class="line">    <a class="code" href="_j1939_8h_ade5a2ccfd9902b6d68f7970ab7dab849.html#ade5a2ccfd9902b6d68f7970ab7dab849">J1939_Request_PGN</a>(0x00F102,J1939_GLOBAL_ADDRESS,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>);</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> readMsg( <span class="keywordtype">void</span> )</div><div class="line">{</div><div class="line">    <a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html">J1939_MESSAGE</a> _msg[2];</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="_j1939_8h_abf1da75af4a339cf813e76205b281480.html#abf1da75af4a339cf813e76205b281480">J1939_Read_Message</a>( _msg, <a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baa7dea1c850a0e3f15d01b1209805b79a">Select_CAN_NODE_1</a>) == RC_SUCCESS) </div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x000100)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x00F101)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">    <span class="keywordflow">if</span>(<a class="code" href="_j1939_8h_abf1da75af4a339cf813e76205b281480.html#abf1da75af4a339cf813e76205b281480">J1939_Read_Message</a>( (_msg+1), <a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>) == RC_SUCCESS) </div><div class="line">    {</div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x000101)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">        <span class="keywordflow">if</span>(_msg.<a class="code" href="union_j1939___m_e_s_s_a_g_e___u_n_i_o_n.html#a19ca4a91edcc8b6fa4a8fac99a4a3399">Mxe</a>.PGN == 0x00F102)</div><div class="line">        {</div><div class="line">            ;<span class="comment">//你的代码</span></div><div class="line">        }</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <span class="comment">//初始化can驱动，定时器初始化</span></div><div class="line">    init_can();</div><div class="line">    timerInit(10);</div><div class="line">    <span class="comment">//初始化J1939协议栈</span></div><div class="line">    <a class="code" href="_j1939_8h_ab49a630de94d8e03e275e3691626d89e.html#ab49a630de94d8e03e275e3691626d89e">J1939_Initialization</a>();</div><div class="line"></div><div class="line">    <span class="comment">//在这里启动定时器</span></div><div class="line">    timerStart();</div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        <span class="comment">/*如果按键1被按下*/</span></div><div class="line">        <span class="keywordflow">if</span>(1)</div><div class="line">        {</div><div class="line">            my_Request_PGN_1( );</div><div class="line">        }</div><div class="line">        <span class="comment">/*如果按键2被按下*/</span></div><div class="line">        <span class="keywordflow">if</span>(2)</div><div class="line">        {</div><div class="line">            my_Request_PGN_2( );</div><div class="line">        }</div><div class="line">        readMsg();</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">//开启一个定时器 10MS </span></div><div class="line"><span class="keywordtype">void</span> timer_j1939()</div><div class="line">{</div><div class="line">      <a class="code" href="_j1939_8h_adfc3c184a14f94b83a28073a15264d5c.html#adfc3c184a14f94b83a28073a15264d5c">J1939_Poll</a>();</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> delay_10ms(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i,j,k;</div><div class="line">    <span class="keywordflow">for</span>(i=5;i&gt;0;i--)</div><div class="line">        <span class="keywordflow">for</span>(j=4;j&gt;0;j--)</div><div class="line">            <span class="keywordflow">for</span>(k=248;k&gt;0;k--);</div><div class="line">}</div></div><!-- fragment --> <h1><a class="anchor" id="autotoc_md28"></a>
创建一个请求响应</h1>
<blockquote class="doxtable">
<p>1.假设已经将J1939协议栈移植完毕，CAN驱动也正常工作 2.采用轮训模式 </p>
</blockquote>
<blockquote class="doxtable">
<p>直接上代码： </p>
</blockquote>
<div class="fragment"><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ResponseTestData[8];</div><div class="line"><span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ResponseTestTPData[17];</div><div class="line"></div><div class="line"><span class="comment">/*用来更新数据的函数， PGN响应功能被请求消息触发时，都会提前调用本函数，然后发送 ACK和NACK等消息，和被请求的PGN消息。*/</span></div><div class="line"><span class="comment">/*此函数不宜写的太复杂，浪费CPU资源*/</span></div><div class="line"><span class="keywordtype">void</span> ResponseTestUpdata()</div><div class="line">{</div><div class="line">    ResponseTestData[0] = 1;<span class="comment">//BatInfo.Voltage是一个全局变量，用作记录采集的电压</span></div><div class="line">    ResponseTestData[1] = 2;</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> ResponseTest()</div><div class="line">{</div><div class="line">    <span class="comment">/*响应是单帧还是多帧，接口通过代入的数据长度识别，PDU1还是PDU2,通过PGN识别*/</span></div><div class="line">    <span class="comment">/*创建一个单帧PGN的响应*/</span></div><div class="line">    <a class="code" href="_j1939_8h_a70a740723a7139eef9dbc3f73c327cd2.html#a70a740723a7139eef9dbc3f73c327cd2">J1939_Create_Response</a>(ResponseTestData,8,0x000200,ResponseTestUpdata,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>);</div><div class="line">    <span class="comment">/*创建一个多帧PGN的响应,我们不要更新数据时，带入J1939_NULL*/</span></div><div class="line">    <a class="code" href="_j1939_8h_a70a740723a7139eef9dbc3f73c327cd2.html#a70a740723a7139eef9dbc3f73c327cd2">J1939_Create_Response</a>(ResponseTestTPData,17,0x00FE33,J1939_NULL,<a class="code" href="_j1939_8h_afa47c62b47948afd20d3bf018a4fa67b.html#afa47c62b47948afd20d3bf018a4fa67baae1511c6e2916d45af460e1a43d18a80">Select_CAN_NODE_2</a>);</div><div class="line">}</div><div class="line"><span class="keywordtype">int</span> main()</div><div class="line">{</div><div class="line">    <a class="code" href="_j1939_8h.html#a9e9f4a9bd6c4a189e06fa67d441d65f7">j1939_int8_t</a> _data[100] = {1,2,3,4,5,6,7,8,9,0,1,2,3,4,5,6,7};</div><div class="line">    <span class="comment">//初始化can驱动，定时器初始化</span></div><div class="line">    init_can();</div><div class="line">    timerInit(10);</div><div class="line">    <span class="comment">//初始化J1939协议栈</span></div><div class="line">    <a class="code" href="_j1939_8h_ab49a630de94d8e03e275e3691626d89e.html#ab49a630de94d8e03e275e3691626d89e">J1939_Initialization</a>();</div><div class="line"></div><div class="line">    <span class="comment">//创建两个请求响应，（单帧和长帧）</span></div><div class="line">    ResponseTest();</div><div class="line"></div><div class="line">    <span class="comment">//在这里启动定时器</span></div><div class="line">    timerStart();</div><div class="line">    <span class="keywordflow">while</span>(1)</div><div class="line">    {</div><div class="line">        ;</div><div class="line">    }</div><div class="line">}</div><div class="line"><span class="comment">//开启一个定时器 10MS </span></div><div class="line"><span class="keywordtype">void</span> timer_j1939()</div><div class="line">{</div><div class="line">      <a class="code" href="_j1939_8h_adfc3c184a14f94b83a28073a15264d5c.html#adfc3c184a14f94b83a28073a15264d5c">J1939_Poll</a>();</div><div class="line">}</div><div class="line"><span class="keywordtype">void</span> delay_10ms(<span class="keywordtype">void</span>)</div><div class="line">{</div><div class="line">    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> i,j,k;</div><div class="line">    <span class="keywordflow">for</span>(i=5;i&gt;0;i--)</div><div class="line">        <span class="keywordflow">for</span>(j=4;j&gt;0;j--)</div><div class="line">            <span class="keywordflow">for</span>(k=248;k&gt;0;k--);</div><div class="line">}</div></div><!-- fragment --> </div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">生成于 2018年 一月 24日 星期三 19:20:25 , 为 J1939Socket使用 
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.14 </li>
  </ul>
</div>
</body>
</html>
